name: Tools Release (Dynamic)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  UPX_VERSION: "4.2.2"

on:
  release:
    types: [prereleased, released, created]
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tool_filter:
        description: "Filter to specific tool (leave empty for all)"
        required: false
        default: ""
        type: string

permissions:
  contents: write

jobs:
  discover:
    name: Discover Tools
    runs-on: ubuntu-latest
    outputs:
      tools_matrix: ${{ steps.discover.outputs.tools_matrix }}
      has_tools: ${{ steps.discover.outputs.has_tools }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Discover tools dynamically
        id: discover
        run: |
          python3 .github/scripts/discover_tools.py --format github >> $GITHUB_OUTPUT
          
          # Check if we have tools
          TOOLS_JSON=$(grep "tools_matrix=" $GITHUB_OUTPUT | cut -d= -f2-)
          TOOL_COUNT=$(echo "$TOOLS_JSON" | python3 -c "import sys, json; print(len(json.load(sys.stdin)))")
          
          if [ "$TOOL_COUNT" -gt 0 ]; then
            echo "has_tools=true" >> $GITHUB_OUTPUT
          else
            echo "has_tools=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Discovered $TOOL_COUNT tools"

  build:
    name: Build ${{ matrix.tool.display_name }} (${{ matrix.os }}, ${{ matrix.python-version }}, ${{ matrix.architecture }})
    needs: discover
    if: needs.discover.outputs.has_tools == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        tool: ${{ fromJson(needs.discover.outputs.tools_matrix) }}
        os: [windows-latest, ubuntu-latest, macos-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
        architecture: [x64]
        exclude:
          # Exclude older Python on newer runners
          - os: macos-latest
            python-version: "3.8"
          - os: macos-latest
            python-version: "3.9"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.architecture }}
      
      - name: Download UPX (Windows)
        if: runner.os == 'Windows'
        run: |
          $upxUrl = "https://github.com/upx/upx/releases/download/v${{ env.UPX_VERSION }}/upx-${{ env.UPX_VERSION }}-win64.zip"
          Invoke-WebRequest -Uri $upxUrl -OutFile upx.zip
          Expand-Archive upx.zip -DestinationPath .
          echo "UPX_DIR=$PWD/upx-${{ env.UPX_VERSION }}-win64" >> $env:GITHUB_ENV
        shell: pwsh
      
      - name: Install dependencies
        run: |
          ./compile/deps_tool.ps1 --tool-path "${{ matrix.tool.path }}" --noprompt --force-python-version "${{ matrix.python-version }}"
        shell: pwsh
      
      - name: Build tool
        id: build
        run: |
          $buildArgs = @(
            '--tool-path', '${{ matrix.tool.path }}',
            '--python-exe', (python -c "import sys; print(sys.executable)")
          )
          
          if ($env:UPX_DIR) {
            $buildArgs += @('--upx-dir', $env:UPX_DIR)
          }
          
          if ("${{ matrix.tool.requires_qt }}" -eq "true") {
            $buildArgs += @('--qt-api', 'PyQt6', '--exclude-other-qt')
            $env:QT_API = "PyQt6"
          }
          
          ./compile/compile_tool.ps1 @buildArgs
        shell: pwsh
      
      - name: Determine artifact name
        id: artifact
        run: |
          $toolName = "${{ matrix.tool.display_name }}"
          $artifactName = "${toolName}_${{ runner.os }}_${{ matrix.architecture }}"
          
          if ("${{ matrix.tool.requires_qt }}" -eq "true") {
            $artifactName = "${toolName}_${{ runner.os }}_PyQt6_${{ matrix.architecture }}"
          }
          
          echo "name=$artifactName" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: ./dist/**
          retention-days: 90
