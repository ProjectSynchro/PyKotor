name: Test Build Action - Local

on: workflow_dispatch

jobs:
  test-build-action:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Discover a tool to build
        id: discover
        run: |
          python - << 'PYTHON_SCRIPT'
          import json
          import os
          import subprocess

          tools = json.loads(subprocess.check_output([
              "python",
              ".github/scripts/discover_tools.py",
              "--format",
              "json",
          ], text=True))

          if not tools:
              raise SystemExit("No tools discovered")

          # Prefer a Qt tool for coverage, fallback to first tool
          tool = next((t for t in tools if t.get("requires_qt")), tools[0])

          output_path = os.environ.get("GITHUB_OUTPUT")
          with open(output_path, "a") as fh:
              fh.write(f"tool_path={tool['path']}\n")
              fh.write(f"tool_display_name={tool.get('display_name') or tool['directory']}\n")
              fh.write(f"tool_requires_qt={'true' if tool.get('requires_qt') else 'false'}\n")
          PYTHON_SCRIPT
        shell: pwsh
      
      - name: Test build (dry run)
        uses: ./.github/actions/build-tool
        with:
          tool_path: ${{ steps.discover.outputs.tool_path }}
          tool_display_name: ${{ steps.discover.outputs.tool_display_name }}
          tool_requires_qt: ${{ steps.discover.outputs.tool_requires_qt }}
          python_version: '3.8'
          architecture: 'x64'
          qt_api: 'PyQt6'
          upx_version: '4.2.2'
          upload_artifact: 'false'
          dry_run: 'true'
